import { ChangeDetectionStrategy, ChangeDetectorRef, Input, ViewChildren } from '@angular/core';
import { Component } from '@angular/core';
import { Subject } from 'rxjs';
import { HOT_TOAST_DEFAULT_TIMEOUTS } from '../../constants';
import { resolveValueOrFunction, } from '../../hot-toast.model';
import { filter, takeUntil } from 'rxjs/operators';
import { HotToastComponent } from '../hot-toast/hot-toast.component';
export class HotToastContainerComponent {
    constructor(cdr) {
        this.cdr = cdr;
        this.toasts = [];
        this.toastRefs = [];
        this._offsetMargin = 8;
        this.subscriptionList = [];
        /** Subject for notifying the user that the toast has been closed. */
        this._onClosed = new Subject();
        this.onClosed$ = this._onClosed.asObservable();
    }
    trackById(index, toast) {
        return toast.id;
    }
    calculateOffset(toastId, position) {
        const visibleToasts = this.toasts.filter((t) => t.visible && t.position === position);
        const index = visibleToasts.findIndex((toast) => toast.id === toastId);
        const offset = index !== -1
            ? visibleToasts
                .slice(...(this.defaultConfig.reverseOrder ? [index + 1] : [0, index]))
                .reduce((acc, t) => acc + (t.height || 0) + this._offsetMargin, 0)
            : 0;
        return offset;
    }
    updateHeight(height, toast) {
        toast.height = height;
    }
    addToast(ref) {
        this.toastRefs.push(ref);
        let toast = ref.getToast();
        let subscription;
        this.toasts.push(ref.getToast());
        this.cdr.detectChanges();
        if (toast.observable) {
            ({ toast, subscription } = this.updateSubscription(toast, subscription));
            this.subscriptionList.push(subscription);
        }
        return {
            dispose: () => {
                if (subscription) {
                    subscription.unsubscribe();
                }
                this.closeToast(toast.id);
            },
            updateMessage: (message) => {
                toast.message = message;
                this.cdr.detectChanges();
            },
            updateToast: (options) => {
                this.updateToasts(toast, options);
                this.cdr.detectChanges();
            },
            afterClosed: this.getAfterClosed(toast),
        };
    }
    closeToast(id) {
        const comp = this.hotToastComponentList.find((item) => item.toast.id === id);
        if (comp) {
            comp.close();
        }
    }
    beforeClosed(toast) {
        toast.visible = false;
    }
    afterClosed(closeToast) {
        const toastIndex = this.toasts.findIndex((t) => t.id === closeToast.id);
        if (toastIndex > -1) {
            this._onClosed.next(closeToast);
            this.toasts = this.toasts.filter((t) => t.id !== closeToast.id);
            this.toastRefs = this.toastRefs.filter((t) => t.getToast().id !== closeToast.id);
            this.cdr.detectChanges();
        }
    }
    hasToast(id) {
        return this.toasts.findIndex((t) => t.id === id) > -1;
    }
    ngOnDestroy() {
        this.subscriptionList.forEach((s) => s.unsubscribe());
    }
    updateSubscription(toast, subscription) {
        subscription = toast.observable.pipe(takeUntil(this.getAfterClosed(toast))).subscribe((v) => {
            var _a, _b, _c;
            if ((_a = toast.observableMessages) === null || _a === void 0 ? void 0 : _a.next) {
                toast.message = resolveValueOrFunction(toast.observableMessages.next, v);
                toast = Object.assign(toast, Object.assign(Object.assign(Object.assign(Object.assign({}, toast), { type: 'success', duration: HOT_TOAST_DEFAULT_TIMEOUTS.success }), (_b = this.defaultConfig) === null || _b === void 0 ? void 0 : _b.success), (_c = toast) === null || _c === void 0 ? void 0 : _c.success));
                this.updateToasts(toast);
                this.cdr.detectChanges();
            }
        }, (e) => {
            var _a, _b, _c;
            if ((_a = toast.observableMessages) === null || _a === void 0 ? void 0 : _a.error) {
                toast.message = resolveValueOrFunction(toast.observableMessages.error, e);
                toast = Object.assign(toast, Object.assign(Object.assign(Object.assign(Object.assign({}, toast), { type: 'error', duration: HOT_TOAST_DEFAULT_TIMEOUTS.error }), (_b = this.defaultConfig) === null || _b === void 0 ? void 0 : _b.error), (_c = toast) === null || _c === void 0 ? void 0 : _c.error));
                this.updateToasts(toast);
                this.cdr.detectChanges();
            }
        });
        return { toast, subscription };
    }
    getAfterClosed(toast) {
        return this.onClosed$.pipe(filter((v) => v.id === toast.id));
    }
    updateToasts(toast, options) {
        this.toasts = this.toasts.map((t) => (Object.assign(Object.assign({}, t), (t.id === toast.id && Object.assign(Object.assign({}, toast), options)))));
    }
}
HotToastContainerComponent.decorators = [
    { type: Component, args: [{
                selector: 'hot-toast-container',
                template: "<div style=\"position: fixed; z-index: 9999; top: 0; right: 0; bottom: 0; left: 0; pointer-events: none\">\n  <div style=\"position: relative; height: 100%\">\n    <hot-toast\n      *ngFor=\"let toast of toasts; trackBy: trackById; let i = index\"\n      [toast]=\"toast\"\n      [offset]=\"calculateOffset(toast.id, toast.position)\"\n      [toastRef]=\"toastRefs[i]\"\n      (height)=\"updateHeight($event, toast)\"\n      (beforeClosed)=\"beforeClosed(toast)\"\n      (afterClosed)=\"afterClosed($event)\"\n    ></hot-toast>\n  </div>\n</div>\n",
                changeDetection: ChangeDetectionStrategy.OnPush
            },] }
];
HotToastContainerComponent.ctorParameters = () => [
    { type: ChangeDetectorRef }
];
HotToastContainerComponent.propDecorators = {
    defaultConfig: [{ type: Input }],
    hotToastComponentList: [{ type: ViewChildren, args: [HotToastComponent,] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90LXRvYXN0LWNvbnRhaW5lci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmduZWF0L2hvdC10b2FzdC9zcmMvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9ob3QtdG9hc3QtY29udGFpbmVyL2hvdC10b2FzdC1jb250YWluZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxpQkFBaUIsRUFBRSxLQUFLLEVBQXdCLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN0SCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxPQUFPLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQzdDLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzdELE9BQU8sRUFHTCxzQkFBc0IsR0FPdkIsTUFBTSx1QkFBdUIsQ0FBQztBQUUvQixPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5ELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBT3JFLE1BQU0sT0FBTywwQkFBMEI7SUFpQnJDLFlBQW9CLEdBQXNCO1FBQXRCLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBWjFDLFdBQU0sR0FBWSxFQUFFLENBQUM7UUFDckIsY0FBUyxHQUF3QixFQUFFLENBQUM7UUFFbkIsa0JBQWEsR0FBRyxDQUFDLENBQUM7UUFFM0IscUJBQWdCLEdBQW1CLEVBQUUsQ0FBQztRQUU5QyxxRUFBcUU7UUFDN0QsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFpQixDQUFDO1FBRXpDLGNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBRUwsQ0FBQztJQUU5QyxTQUFTLENBQUMsS0FBYSxFQUFFLEtBQVk7UUFDbkMsT0FBTyxLQUFL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SUFBSSxDQUFDLGFBQWEsMENBQUUsS0FBSyxTQUN4QixLQUE2QiwwQ0FBRSxLQUFLLEVBQ3hDLENBQUM7Z0JBQ0gsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDekIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUMxQjtRQUNILENBQUMsQ0FDRixDQUFDO1FBQ0YsT0FBTyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBRU8sY0FBYyxDQUFDLEtBQVk7UUFDakMsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQUVPLFlBQVksQ0FBQyxLQUFZLEVBQUUsT0FBNEI7UUFDN0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsaUNBQU0sQ0FBQyxHQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxLQUFLLENBQUMsRUFBRSxvQ0FBUyxLQUFLLEdBQUssT0FBTyxDQUFFLENBQUMsRUFBRyxDQUFDLENBQUM7SUFDdkcsQ0FBQzs7O1lBcEpGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUscUJBQXFCO2dCQUMvQiwraUJBQW1EO2dCQUNuRCxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTthQUNoRDs7O1lBeEJpQyxpQkFBaUI7Ozs0QkEwQmhELEtBQUs7b0NBRUwsWUFBWSxTQUFDLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBDaGFuZ2VEZXRlY3RvclJlZiwgSW5wdXQsIE9uRGVzdHJveSwgUXVlcnlMaXN0LCBWaWV3Q2hpbGRyZW4gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbXBvbmVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBIT1RfVE9BU1RfREVGQVVMVF9USU1FT1VUUyB9IGZyb20gJy4uLy4uL2NvbnN0YW50cyc7XG5pbXBvcnQge1xuICBEZWZhdWx0VG9hc3RPcHRpb25zLFxuICBIb3RUb2FzdENsb3NlLFxuICByZXNvbHZlVmFsdWVPckZ1bmN0aW9uLFxuICBUb2FzdCxcbiAgVG9hc3RDb25maWcsXG4gIFRvYXN0UG9zaXRpb24sXG4gIFVwZGF0ZVRvYXN0T3B0aW9ucyxcbiAgQWRkVG9hc3RSZWYsXG4gIENyZWF0ZUhvdFRvYXN0UmVmLFxufSBmcm9tICcuLi8uLi9ob3QtdG9hc3QubW9kZWwnO1xuaW1wb3J0IHsgSG90VG9hc3RSZWYgfSBmcm9tICcuLi8uLi9ob3QtdG9hc3QtcmVmJztcbmltcG9ydCB7IGZpbHRlciwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQ29udGVudCB9IGZyb20gJ0BuZ25lYXQvb3ZlcnZpZXcnO1xuaW1wb3J0IHsgSG90VG9hc3RDb21wb25lbnQgfSBmcm9tICcuLi9ob3QtdG9hc3QvaG90LXRvYXN0LmNvbXBvbmVudCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2hvdC10b2FzdC1jb250YWluZXInLFxuICB0ZW1wbGF0ZVVybDogJy4vaG90LXRvYXN0LWNvbnRhaW5lci5jb21wb25lbnQuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBIb3RUb2FzdENvbnRhaW5lckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgpIGRlZmF1bHRDb25maWc6IFRvYXN0Q29uZmlnO1xuXG4gIEBWaWV3Q2hpbGRyZW4oSG90VG9hc3RDb21wb25lbnQpIGhvdFRvYXN0Q29tcG9uZW50TGlzdDogUXVlcnlMaXN0PEhvdFRvYXN0Q29tcG9uZW50PjtcblxuICB0b2FzdHM6IFRvYXN0W10gPSBbXTtcbiAgdG9hc3RSZWZzOiBDcmVhdGVIb3RUb2FzdFJlZltdID0gW107XG5cbiAgcHJpdmF0ZSByZWFkb25seSBfb2Zmc2V0TWFyZ2luID0gODtcblxuICBwcml2YXRlIHN1YnNjcmlwdGlvbkxpc3Q6IFN1YnNjcmlwdGlvbltdID0gW107XG5cbiAgLyoqIFN1YmplY3QgZm9yIG5vdGlmeWluZyB0aGUgdXNlciB0aGF0IHRoZSB0b2FzdCBoYXMgYmVlbiBjbG9zZWQuICovXG4gIHByaXZhdGUgX29uQ2xvc2VkID0gbmV3IFN1YmplY3Q8SG90VG9hc3RDbG9zZT4oKTtcblxuICBwcml2YXRlIG9uQ2xvc2VkJCA9IHRoaXMuX29uQ2xvc2VkLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZikge31cblxuICB0cmFja0J5SWQoaW5kZXg6IG51bWJlciwgdG9hc3Q6IFRvYXN0KSB7XG4gICAgcmV0dXJuIHRvYXN0LmlkO1xuICB9XG5cbiAgY2FsY3VsYXRlT2Zmc2V0KHRvYXN0SWQ6IHN0cmluZywgcG9zaXRpb246IFRvYXN0UG9zaXRpb24pIHtcbiAgICBjb25zdCB2aXNpYmxlVG9hc3RzID0gdGhpcy50b2FzdHMuZmlsdGVyKCh0KSA9PiB0LnZpc2libGUgJiYgdC5wb3NpdGlvbiA9PT0gcG9zaXRpb24pO1xuICAgIGNvbnN0IGluZGV4ID0gdmlzaWJsZVRvYXN0cy5maW5kSW5kZXgoKHRvYXN0KSA9PiB0b2FzdC5pZCA9PT0gdG9hc3RJZCk7XG4gICAgY29uc3Qgb2Zmc2V0ID1cbiAgICAgIGluZGV4ICE9PSAtMVxuICAgICAgICA/IHZpc2libGVUb2FzdHNcbiAgICAgICAgICAgIC5zbGljZSguLi4odGhpcy5kZWZhdWx0Q29uZmlnLnJldmVyc2VPcmRlciA/IFtpbmRleCArIDFdIDogWzAsIGluZGV4XSkpXG4gICAgICAgICAgICAucmVkdWNlKChhY2MsIHQpID0+IGFjYyArICh0LmhlaWdodCB8fCAwKSArIHRoaXMuX29mZnNldE1hcmdpbiwgMClcbiAgICAgICAgOiAwO1xuICAgIHJldHVybiBvZmZzZXQ7XG4gIH1cblxuICB1cGRhdGVIZWlnaHQoaGVpZ2h0OiBudW1iZXIsIHRvYXN0OiBUb2FzdCkge1xuICAgIHRvYXN0LmhlaWdodCA9IGhlaWdodDtcbiAgfVxuXG4gIGFkZFRvYXN0KHJlZjogSG90VG9hc3RSZWYpOiBBZGRUb2FzdFJlZiB7XG4gICAgdGhpcy50b2FzdFJlZnMucHVzaChyZWYpO1xuXG4gICAgbGV0IHRvYXN0ID0gcmVmLmdldFRvYXN0KCk7XG4gICAgbGV0IHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gICAgdGhpcy50b2FzdHMucHVzaChyZWYuZ2V0VG9hc3QoKSk7XG5cbiAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICBpZiAodG9hc3Qub2JzZXJ2YWJsZSkge1xuICAgICAgKHsgdG9hc3QsIHN1YnNjcmlwdGlvbiB9ID0gdGhpcy51cGRhdGVTdWJzY3JpcHRpb24odG9hc3QsIHN1YnNjcmlwdGlvbikpO1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb25MaXN0LnB1c2goc3Vic2NyaXB0aW9uKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgZGlzcG9zZTogKCkgPT4ge1xuICAgICAgICBpZiAoc3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNsb3NlVG9hc3QodG9hc3QuaWQpO1xuICAgICAgfSxcbiAgICAgIHVwZGF0ZU1lc3NhZ2U6IChtZXNzYWdlOiBDb250ZW50KSA9PiB7XG4gICAgICAgIHRvYXN0Lm1lc3NhZ2UgPSBtZXNzYWdlO1xuICAgICAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICB9LFxuICAgICAgdXBkYXRlVG9hc3Q6IChvcHRpb25zOiBVcGRhdGVUb2FzdE9wdGlvbnMpID0+IHtcbiAgICAgICAgdGhpcy51cGRhdGVUb2FzdHModG9hc3QsIG9wdGlvbnMpO1xuICAgICAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICB9LFxuICAgICAgYWZ0ZXJDbG9zZWQ6IHRoaXMuZ2V0QWZ0ZXJDbG9zZWQodG9hc3QpLFxuICAgIH07XG4gIH1cblxuICBjbG9zZVRvYXN0KGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBjb21wID0gdGhpcy5ob3RUb2FzdENvbXBvbmVudExpc3QuZmluZCgoaXRlbSkgPT4gaXRlbS50b2FzdC5pZCA9PT0gaWQpO1xuICAgIGlmIChjb21wKSB7XG4gICAgICBjb21wLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgYmVmb3JlQ2xvc2VkKHRvYXN0OiBUb2FzdCkge1xuICAgIHRvYXN0LnZpc2libGUgPSBmYWxzZTtcbiAgfVxuXG4gIGFmdGVyQ2xvc2VkKGNsb3NlVG9hc3Q6IEhvdFRvYXN0Q2xvc2UpIHtcbiAgICBjb25zdCB0b2FzdEluZGV4ID0gdGhpcy50b2FzdHMuZmluZEluZGV4KCh0KSA9PiB0LmlkID09PSBjbG9zZVRvYXN0LmlkKTtcbiAgICBpZiAodG9hc3RJbmRleCA+IC0xKSB7XG4gICAgICB0aGlzLl9vbkNsb3NlZC5uZXh0KGNsb3NlVG9hc3QpO1xuICAgICAgdGhpcy50b2FzdHMgPSB0aGlzLnRvYXN0cy5maWx0ZXIoKHQpID0+IHQuaWQgIT09IGNsb3NlVG9hc3QuaWQpO1xuICAgICAgdGhpcy50b2FzdFJlZnMgPSB0aGlzLnRvYXN0UmVmcy5maWx0ZXIoKHQpID0+IHQuZ2V0VG9hc3QoKS5pZCAhPT0gY2xvc2VUb2FzdC5pZCk7XG4gICAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuICB9XG5cbiAgaGFzVG9hc3QoaWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLnRvYXN0cy5maW5kSW5kZXgoKHQpID0+IHQuaWQgPT09IGlkKSA+IC0xO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25MaXN0LmZvckVhY2goKHMpID0+IHMudW5zdWJzY3JpYmUoKSk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVN1YnNjcmlwdGlvbih0b2FzdDogVG9hc3QsIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uKSB7XG4gICAgc3Vic2NyaXB0aW9uID0gdG9hc3Qub2JzZXJ2YWJsZS5waXBlKHRha2VVbnRpbCh0aGlzLmdldEFmdGVyQ2xvc2VkKHRvYXN0KSkpLnN1YnNjcmliZShcbiAgICAgICh2KSA9PiB7XG4gICAgICAgIGlmICh0b2FzdC5vYnNlcnZhYmxlTWVzc2FnZXM/Lm5leHQpIHtcbiAgICAgICAgICB0b2FzdC5tZXNzYWdlID0gcmVzb2x2ZVZhbHVlT3JGdW5jdGlvbih0b2FzdC5vYnNlcnZhYmxlTWVzc2FnZXMubmV4dCwgdik7XG4gICAgICAgICAgdG9hc3QgPSBPYmplY3QuYXNzaWduKHRvYXN0LCB7XG4gICAgICAgICAgICAuLi50b2FzdCxcbiAgICAgICAgICAgIHR5cGU6ICdzdWNjZXNzJyxcbiAgICAgICAgICAgIGR1cmF0aW9uOiBIT1RfVE9BU1RfREVGQVVMVF9USU1FT1VUUy5zdWNjZXNzLFxuICAgICAgICAgICAgLi4udGhpcy5kZWZhdWx0Q29uZmlnPy5zdWNjZXNzLFxuICAgICAgICAgICAgLi4uKHRvYXN0IGFzIERlZmF1bHRUb2FzdE9wdGlvbnMpPy5zdWNjZXNzLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMudXBkYXRlVG9hc3RzKHRvYXN0KTtcbiAgICAgICAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICAoZSkgPT4ge1xuICAgICAgICBpZiAodG9hc3Qub2JzZXJ2YWJsZU1lc3NhZ2VzPy5lcnJvcikge1xuICAgICAgICAgIHRvYXN0Lm1lc3NhZ2UgPSByZXNvbHZlVmFsdWVPckZ1bmN0aW9uKHRvYXN0Lm9ic2VydmFibGVNZXNzYWdlcy5lcnJvciwgZSk7XG4gICAgICAgICAgdG9hc3QgPSBPYmplY3QuYXNzaWduKHRvYXN0LCB7XG4gICAgICAgICAgICAuLi50b2FzdCxcbiAgICAgICAgICAgIHR5cGU6ICdlcnJvcicsXG4gICAgICAgICAgICBkdXJhdGlvbjogSE9UX1RPQVNUX0RFRkFVTFRfVElNRU9VVFMuZXJyb3IsXG4gICAgICAgICAgICAuLi50aGlzLmRlZmF1bHRDb25maWc/LmVycm9yLFxuICAgICAgICAgICAgLi4uKHRvYXN0IGFzIERlZmF1bHRUb2FzdE9wdGlvbnMpPy5lcnJvcixcbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aGlzLnVwZGF0ZVRvYXN0cyh0b2FzdCk7XG4gICAgICAgICAgdGhpcy5jZHIuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgKTtcbiAgICByZXR1cm4geyB0b2FzdCwgc3Vic2NyaXB0aW9uIH07XG4gIH1cblxuICBwcml2YXRlIGdldEFmdGVyQ2xvc2VkKHRvYXN0OiBUb2FzdCkge1xuICAgIHJldHVybiB0aGlzLm9uQ2xvc2VkJC5waXBlKGZpbHRlcigodikgPT4gdi5pZCA9PT0gdG9hc3QuaWQpKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlVG9hc3RzKHRvYXN0OiBUb2FzdCwgb3B0aW9ucz86IFVwZGF0ZVRvYXN0T3B0aW9ucykge1xuICAgIHRoaXMudG9hc3RzID0gdGhpcy50b2FzdHMubWFwKCh0KSA9PiAoeyAuLi50LCAuLi4odC5pZCA9PT0gdG9hc3QuaWQgJiYgeyAuLi50b2FzdCwgLi4ub3B0aW9ucyB9KSB9KSk7XG4gIH1cbn1cbiJdfQ==